<html>
    <head>
        <title>Publish Tool</title>
        <style>
            .form {
                padding-bottom: 5;
                text-align: center;
            }
            .manual-form {
                border-bottom: solid;
                margin-bottom: 5px;
                display: none;
            }
            .publish-ui {
                margin-top: 20px;
            }
            .publish-logger-container {
                border: none;
                display: none;
            }
            .publish-logger {
                border: none;
                width: 100%;
                height: 100%;
                margin-bottom: 10;
            }
            .url {
                margin-left: 0;
            }
            .url input {
                border: 0;
            }
            .env-op-label {
                margin-left: 50;
            }
            .log-btn {
                display: none;
                align-self: center;
                margin-left: 5px;
            }
            .log-bottons {
                display: flex;
                flex-direction: row;
            }
            #prev-btn {
                margin-left: 50;
            }
            #url-text {
                width: 95%;
            }
            #log-counter {
                padding-left: 10px;
            }
        </style>
        <!--
        <script type="module">
            import { Octokit } from "https://esm.sh/@octokit/core";
        </script> -->
        <script src="./bulk.js" defer></script>
        <script>
            const projectHost = 'helix-sportsmagazine--headwirecom.hlx';
            const [repo, owner] = projectHost.split('.')[0].split('--');

            let environment = 'main';
            let previewImportHost = `https://${environment}--${projectHost}.page`;
            let liveImportHost = `https://${environment}--${projectHost}.live`;
/*
            async function getEnvironments() {
                const octokit = new Octokit({});

                let resp = await octokit.request(`GET /repos/${owner}/${repo}/branches`, {
                    owner: 'OWNER',
                    repo: 'REPO',
                    headers: {
                        'X-GitHub-Api-Version': '2022-11-28'
                    }
                });
            }*/

            getEnvironments();

            const logger = {
                count: 0,
                
                append: (s, showCount = true) => {
                    if (showCount) s.insertAdjacentHTML('afterbegin', `<span>${count}. </span>`);
                    document.querySelector('.publish-logger').contentDocument.body.append(s);
                },

                updateCounter: () => {
                    count = count + 1;
                    const txt = `<span class="log-counter-text">${count}</span>`;
                    document.querySelector('#log-counter').innerHTML = txt;
                },

                clear: (clearCount = true) => {
                    if (clearCount) {
                        count = 0;
                        document.querySelector('#log-counter').innerHTML = '';
                    }
                    document.querySelector('.publish-logger').contentDocument.body.innerHTML = '';
                }
            };

            function getPublishLogger() {
                return logger;
            }

            function showLogger(show) {
                document.querySelector('.publish-logger-container').style.display = (show) ? 'block' : 'none';
                document.querySelector('.hide-log-btn').style.display = (show) ? 'block' : 'none';
                document.querySelector('.show-log-btn').style.display = (show) ? 'none' : 'block';
                document.querySelector('.clear-log-btn').style.display = (show) ? 'block' : 'none';
            }
            function appendLog(string, el = 'p') {
                let logger = getPublishLogger();
                if (logger) {
                    let line = document.createElement(el);
                    line.innerHTML = string;
                    logger.append(line);
                }
                console.log(string);
            }
            function clearLog(clearAndHide, clearCount = true) {
                let logger = getPublishLogger();
                logger.clear(clearCount);
                if (clearAndHide) {
                    document.querySelector('.publish-logger-container').style.display = 'none';
                    document.querySelectorAll('.log-btn').forEach(el => {el.style.display = 'none';});
                }
            }

            function isManualEntry() {
                return document.querySelector('.page-type').value === 'manual';
            }

            function publishOpChange() {
                const op = document.querySelector('.publish-op').value;
                
                if (op === "status") {
                    // status op only supports GET
                    document.querySelector('.op-method').disabled = true;
                    document.querySelector('.op-method').value = "GET";
                } else if (op === "cache") {
                    // cache op only supports GET
                    document.querySelector('.op-method').disabled = true;
                    document.querySelector('.op-method').value = "POST";
                } else {
                    document.querySelector('.op-method').disabled = false;
                }
            }

            function envChange() {
                environment = document.querySelector('.env-op').value;
                if (environment === 'dev') {
                    document.querySelector('.publish-btn').disabled = true;
                } else {
                    document.querySelector('.publish-btn').disabled = false;
                    previewImportHost = `https://${environment}--${projectHost}.page`;
                    liveImportHost = `https://${environment}--${projectHost}.live`;
                }
            }

            function toggleManualForm(show) {
                const display = show ? 'block' : 'none';
                document.getElementById('url-list-container').style.display = display;
            }
        </script>
    </head>
    <body> 
        <div class="main">
            <div class="form manual-form">
                <div>
                    <label>Enter a list of URLs (one per line) and click Run.</label>
                    <input id="manual-form-toggle" type="checkbox" onchange="toggleManualForm(this.checked)" checked/>
                </div>
                <div id="url-list-container">
                <textarea id="url-list" rows="20" cols="150"></textarea>
                </div>
            </div>
            <div class="form">
                <label class="drive-folder-label" for="drive-folder">Google Drive Folder ID:</label>
                <input class="drive-folder" size="50" value="1OudSl2TFxb6fyr6j7KA1UQIb8On-jMAq"/>
                <label class="context-label" for="drive-folder">Root Web Context:</label>
                <input class="web-context" size="10" value="/"/>
                <label class="env-op-label" for="env-op">Branch:</label>
                <select class="env-op" onchange="envChange()">
                    <option value="main" selected>main</option>
                </select>
                <label class="api-op-label" for="publish-op">API Call:</label>
                <select class="publish-op" onchange="publishOpChange()">
                    <option value="preview" selected>preview</option>
                    <option value="live">live</option>
                    <option value="index">index</option>
                    <option value="cache">cache</option>
                    <option value="status">status</option>
                </select>
                <label class="api-op-label" for="op-method">Method:</label>
                <select class="op-method">
                    <option value="GET" selected>GET</option>
                    <option value="POST">POST</option>
                    <option value="DEL">DELETE</option>
                </select>
                <button class="publish-btn" onclick="run()" disabled>Run</button>
                <button class="file-scan-btn" onclick="fileScan()" disabled>List Files</button>
            </div>
            <div class="form log-bottons">
                <button class="show-log-btn log-btn" onclick="showLogger(true)">Show Publish Log</button>
                <button class="hide-log-btn log-btn" onclick="showLogger(false)">Hide Publish Log</button>
                <button class="clear-log-btn log-btn" onclick="clearLog(false, false)">Clear Publish Log</button>
                <div id="log-counter"></div>
            </div>
            <div class="publish-logger-container" style="display: none;">
                <iframe class="publish-logger"></iframe>
            </div>
        </div>
        <script src="publish.js"></script>
        <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
        <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
        <script>
            function disableInput(isDisabled = true) {
                if (isDisabled) {
                    document.querySelector('.publish-btn').setAttribute('disabled', '');
                    document.querySelector('.file-scan-btn').setAttribute('disabled', '');
                } else {
                    document.querySelector('.publish-btn').removeAttribute('disabled');
                    document.querySelector('.file-scan-btn').removeAttribute('disabled');
                }
            }

            function onFileScanFile(file, filePath) {
                getPublishLogger().updateCounter();
                appendLog(filePath, 'div');
            }

            async function fileScan() {
                disableInput();
                let folderId = document.querySelector('.drive-folder').value;
                let rootPath = document.querySelector('.web-context').value;
                clearLog();
                showLogger(true);
                await scanFiles(folderId, onFileScanFile, true, rootPath);
                disableInput(false);
            }

            async function run() {
                disableInput();
                let folderId = document.querySelector('.drive-folder').value;
                let rootPath = document.querySelector('.web-context').value;
                clearLog();
                showLogger(true);

                let urls = [];
                const operation = document.querySelector('.publish-op').value;
                const host = (operation === 'live') ? liveImportHost : previewImportHost;
                const callback = async (file, filePath) => {
                    let url = `${host}${filePath}`;
                    console.log(`publishing ${url}`)
                    urls.push(url);
                    if (urls.length > 999) {
                        await bulk(urls, operation, getPublishLogger(), document.querySelector('.op-method').value, 0);
                        urls = [];
                    }
                } 
                await scanFiles(folderId, callback, true, rootPath);
                if (urls.length > 0) {
                    appendLog(`Processing ${urls.length} documents.`);
                    await bulk(urls, operation, getPublishLogger(), document.querySelector('.op-method').value, 0);
                    urls = [];
                }
                disableInput(false);
            }
        </script>
    </body>
</html>